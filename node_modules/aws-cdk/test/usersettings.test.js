"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable import/order */
const os = require("os");
const fs_path = require("path");
const fs = require("fs-extra");
const utils_1 = require("ts-jest/utils");
const settings_1 = require("../lib/settings");
// mock fs deeply
jest.mock('fs-extra');
const mockedFs = (0, utils_1.mocked)(fs, true);
const USER_CONFIG = fs_path.join(os.homedir(), '.cdk.json');
test('load settings from both files if available', async () => {
    // GIVEN
    const GIVEN_CONFIG = new Map([
        [settings_1.PROJECT_CONFIG, {
                project: 'foobar',
            }],
        [USER_CONFIG, {
                project: 'foo',
                test: 'bar',
            }],
    ]);
    // WHEN
    mockedFs.pathExists.mockImplementation(path => {
        return GIVEN_CONFIG.has(path);
    });
    mockedFs.readJSON.mockImplementation(path => {
        return GIVEN_CONFIG.get(path);
    });
    const config = await new settings_1.Configuration().load();
    // THEN
    expect(config.settings.get(['project'])).toBe('foobar');
    expect(config.settings.get(['test'])).toBe('bar');
});
test('load context from all 3 files if available', async () => {
    // GIVEN
    const GIVEN_CONFIG = new Map([
        [settings_1.PROJECT_CONFIG, {
                context: {
                    project: 'foobar',
                },
            }],
        [settings_1.PROJECT_CONTEXT, {
                foo: 'bar',
            }],
        [USER_CONFIG, {
                context: {
                    test: 'bar',
                },
            }],
    ]);
    // WHEN
    mockedFs.pathExists.mockImplementation(path => {
        return GIVEN_CONFIG.has(path);
    });
    mockedFs.readJSON.mockImplementation(path => {
        return GIVEN_CONFIG.get(path);
    });
    const config = await new settings_1.Configuration().load();
    // THEN
    expect(config.context.get('project')).toBe('foobar');
    expect(config.context.get('foo')).toBe('bar');
    expect(config.context.get('test')).toBe('bar');
});
test('throws an error if the `build` key is specified in the user config', async () => {
    // GIVEN
    const GIVEN_CONFIG = new Map([
        [USER_CONFIG, {
                build: 'foobar',
            }],
    ]);
    // WHEN
    mockedFs.pathExists.mockImplementation(path => {
        return GIVEN_CONFIG.has(path);
    });
    mockedFs.readJSON.mockImplementation(path => {
        return GIVEN_CONFIG.get(path);
    });
    // THEN
    await expect(new settings_1.Configuration().load()).rejects.toEqual(new Error('The `build` key cannot be specified in the user config (~/.cdk.json), specify it in the project config (cdk.json) instead'));
});
test('Can specify the `quiet` key in the user config', async () => {
    // GIVEN
    const GIVEN_CONFIG = new Map([
        [USER_CONFIG, {
                quiet: true,
            }],
    ]);
    // WHEN
    mockedFs.pathExists.mockImplementation(path => {
        return GIVEN_CONFIG.has(path);
    });
    mockedFs.readJSON.mockImplementation(path => {
        return GIVEN_CONFIG.get(path);
    });
    // THEN
    const config = await new settings_1.Configuration().load();
    expect(config.settings.get(['quiet'])).toBe(true);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlcnNldHRpbmdzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1c2Vyc2V0dGluZ3MudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUFpQztBQUNqQyx5QkFBeUI7QUFDekIsZ0NBQWdDO0FBQ2hDLCtCQUErQjtBQUMvQix5Q0FBdUM7QUFDdkMsOENBQWlGO0FBRWpGLGlCQUFpQjtBQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3RCLE1BQU0sUUFBUSxHQUFHLElBQUEsY0FBTSxFQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUVsQyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUU1RCxJQUFJLENBQUMsNENBQTRDLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDNUQsUUFBUTtJQUNSLE1BQU0sWUFBWSxHQUFxQixJQUFJLEdBQUcsQ0FBQztRQUM3QyxDQUFDLHlCQUFjLEVBQUU7Z0JBQ2YsT0FBTyxFQUFFLFFBQVE7YUFDbEIsQ0FBQztRQUNGLENBQUMsV0FBVyxFQUFFO2dCQUNaLE9BQU8sRUFBRSxLQUFLO2dCQUNkLElBQUksRUFBRSxLQUFLO2FBQ1osQ0FBQztLQUNILENBQUMsQ0FBQztJQUVILE9BQU87SUFDUCxRQUFRLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzVDLE9BQU8sWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUMsQ0FBQztJQUNILFFBQVEsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDMUMsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJ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LFlBQVksR0FBcUIsSUFBSSxHQUFHLENBQUM7UUFDN0MsQ0FBQyxXQUFXLEVBQUU7Z0JBQ1osS0FBSyxFQUFFLElBQUk7YUFDWixDQUFDO0tBQ0gsQ0FBQyxDQUFDO0lBRUgsT0FBTztJQUNQLFFBQVEsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDNUMsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUMxQyxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPO0lBQ1AsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLHdCQUFhLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVoRCxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3BELENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgaW1wb3J0L29yZGVyICovXG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBmc19wYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgbW9ja2VkIH0gZnJvbSAndHMtamVzdC91dGlscyc7XG5pbXBvcnQgeyBDb25maWd1cmF0aW9uLCBQUk9KRUNUX0NPTkZJRywgUFJPSkVDVF9DT05URVhUIH0gZnJvbSAnLi4vbGliL3NldHRpbmdzJztcblxuLy8gbW9jayBmcyBkZWVwbHlcbmplc3QubW9jaygnZnMtZXh0cmEnKTtcbmNvbnN0IG1vY2tlZEZzID0gbW9ja2VkKGZzLCB0cnVlKTtcblxuY29uc3QgVVNFUl9DT05GSUcgPSBmc19wYXRoLmpvaW4ob3MuaG9tZWRpcigpLCAnLmNkay5qc29uJyk7XG5cbnRlc3QoJ2xvYWQgc2V0dGluZ3MgZnJvbSBib3RoIGZpbGVzIGlmIGF2YWlsYWJsZScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3QgR0lWRU5fQ09ORklHOiBNYXA8c3RyaW5nLCBhbnk+ID0gbmV3IE1hcChbXG4gICAgW1BST0pFQ1RfQ09ORklHLCB7XG4gICAgICBwcm9qZWN0OiAnZm9vYmFyJyxcbiAgICB9XSxcbiAgICBbVVNFUl9DT05GSUcsIHtcbiAgICAgIHByb2plY3Q6ICdmb28nLFxuICAgICAgdGVzdDogJ2JhcicsXG4gICAgfV0sXG4gIF0pO1xuXG4gIC8vIFdIRU5cbiAgbW9ja2VkRnMucGF0aEV4aXN0cy5tb2NrSW1wbGVtZW50YXRpb24ocGF0aCA9PiB7XG4gICAgcmV0dXJuIEdJVkVOX0NPTkZJRy5oYXMocGF0aCk7XG4gIH0pO1xuICBtb2NrZWRGcy5yZWFkSlNPTi5tb2NrSW1wbGVtZW50YXRpb24ocGF0aCA9PiB7XG4gICAgcmV0dXJuIEdJVkVOX0NPTkZJRy5nZXQocGF0aCk7XG4gIH0pO1xuXG4gIGNvbnN0IGNvbmZpZyA9IGF3YWl0IG5ldyBDb25maWd1cmF0aW9uKCkubG9hZCgpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KGNvbmZpZy5zZXR0aW5ncy5nZXQoWydwcm9qZWN0J10pKS50b0JlKCdmb29iYXInKTtcbiAgZXhwZWN0KGNvbmZpZy5zZXR0aW5ncy5nZXQoWyd0ZXN0J10pKS50b0JlKCdiYXInKTtcbn0pO1xuXG50ZXN0KCdsb2FkIGNvbnRleHQgZnJvbSBhbGwgMyBmaWxlcyBpZiBhdmFpbGFibGUnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IEdJVkVOX0NPTkZJRzogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXAoW1xuICAgIFtQUk9KRUNUX0NPTkZJRywge1xuICAgICAgY29udGV4dDoge1xuICAgICAgICBwcm9qZWN0OiAnZm9vYmFyJyxcbiAgICAgIH0sXG4gICAgfV0sXG4gICAgW1BST0pFQ1RfQ09OVEVYVCwge1xuICAgICAgZm9vOiAnYmFyJyxcbiAgICB9XSxcbiAgICBbVVNFUl9DT05GSUcsIHtcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgdGVzdDogJ2JhcicsXG4gICAgICB9LFxuICAgIH1dLFxuICBdKTtcblxuICAvLyBXSEVOXG4gIG1vY2tlZEZzLnBhdGhFeGlzdHMubW9ja0ltcGxlbWVudGF0aW9uKHBhdGggPT4ge1xuICAgIHJldHVybiBHSVZFTl9DT05GSUcuaGFzKHBhdGgpO1xuICB9KTtcbiAgbW9ja2VkRnMucmVhZEpTT04ubW9ja0ltcGxlbWVudGF0aW9uKHBhdGggPT4ge1xuICAgIHJldHVybiBHSVZFTl9DT05GSUcuZ2V0KHBhdGgpO1xuICB9KTtcblxuICBjb25zdCBjb25maWcgPSBhd2FpdCBuZXcgQ29uZmlndXJhdGlvbigpLmxvYWQoKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChjb25maWcuY29udGV4dC5nZXQoJ3Byb2plY3QnKSkudG9CZSgnZm9vYmFyJyk7XG4gIGV4cGVjdChjb25maWcuY29udGV4dC5nZXQoJ2ZvbycpKS50b0JlKCdiYXInKTtcbiAgZXhwZWN0KGNvbmZpZy5jb250ZXh0LmdldCgndGVzdCcpKS50b0JlKCdiYXInKTtcbn0pO1xuXG50ZXN0KCd0aHJvd3MgYW4gZXJyb3IgaWYgdGhlIGBidWlsZGAga2V5IGlzIHNwZWNpZmllZCBpbiB0aGUgdXNlciBjb25maWcnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IEdJVkVOX0NPTkZJRzogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXAoW1xuICAgIFtVU0VSX0NPTkZJRywge1xuICAgICAgYnVpbGQ6ICdmb29iYXInLFxuICAgIH1dLFxuICBdKTtcblxuICAvLyBXSEVOXG4gIG1vY2tlZEZzLnBhdGhFeGlzdHMubW9ja0ltcGxlbWVudGF0aW9uKHBhdGggPT4ge1xuICAgIHJldHVybiBHSVZFTl9DT05GSUcuaGFzKHBhdGgpO1xuICB9KTtcbiAgbW9ja2VkRnMucmVhZEpTT04ubW9ja0ltcGxlbWVudGF0aW9uKHBhdGggPT4ge1xuICAgIHJldHVybiBHSVZFTl9DT05GSUcuZ2V0KHBhdGgpO1xuICB9KTtcblxuICAvLyBUSEVOXG4gIGF3YWl0IGV4cGVjdChuZXcgQ29uZmlndXJhdGlvbigpLmxvYWQoKSkucmVqZWN0cy50b0VxdWFsKG5ldyBFcnJvcignVGhlIGBidWlsZGAga2V5IGNhbm5vdCBiZSBzcGVjaWZpZWQgaW4gdGhlIHVzZXIgY29uZmlnICh+Ly5jZGsuanNvbiksIHNwZWNpZnkgaXQgaW4gdGhlIHByb2plY3QgY29uZmlnIChjZGsuanNvbikgaW5zdGVhZCcpKTtcbn0pO1xuXG50ZXN0KCdDYW4gc3BlY2lmeSB0aGUgYHF1aWV0YCBrZXkgaW4gdGhlIHVzZXIgY29uZmlnJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBHSVZFTl9DT05GSUc6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwKFtcbiAgICBbVVNFUl9DT05GSUcsIHtcbiAgICAgIHF1aWV0OiB0cnVlLFxuICAgIH1dLFxuICBdKTtcblxuICAvLyBXSEVOXG4gIG1vY2tlZEZzLnBhdGhFeGlzdHMubW9ja0ltcGxlbWVudGF0aW9uKHBhdGggPT4ge1xuICAgIHJldHVybiBHSVZFTl9DT05GSUcuaGFzKHBhdGgpO1xuICB9KTtcbiAgbW9ja2VkRnMucmVhZEpTT04ubW9ja0ltcGxlbWVudGF0aW9uKHBhdGggPT4ge1xuICAgIHJldHVybiBHSVZFTl9DT05GSUcuZ2V0KHBhdGgpO1xuICB9KTtcblxuICAvLyBUSEVOXG4gIGNvbnN0IGNvbmZpZyA9IGF3YWl0IG5ldyBDb25maWd1cmF0aW9uKCkubG9hZCgpO1xuXG4gIGV4cGVjdChjb25maWcuc2V0dGluZ3MuZ2V0KFsncXVpZXQnXSkpLnRvQmUodHJ1ZSk7XG59KTsiXX0=